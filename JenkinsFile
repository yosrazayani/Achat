pipeline {
    agent any
    stages {
        stage("GIT") {
            steps {
                echo "Getting Project from Git"
                git branch: "main",
                    url: "https://github.com/yosrazayani/Achat.git"
            }
        }
    stage('MAVEN') {
            steps {
                sh "mvn -version"

        }
        }

         stage('BUILD') {
                    steps {
                        sh "mvn clean -version"

                }
                }


        stage("SONARQUBE") {
                    steps {
                  //  dir('Achat') {
        // sh "mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=P@ssw0rd"
        sh 'mvn clean package sonar:sonar'
}
                   // }
                }

       stage("MOCKITO") {
         steps {

                    sh 'mvn test'

            }
        }



        stage("MVN NEXUS") {
            steps {
                dir('Achat') {
                    sh 'mvn deploy -DskipTests'
                }
            }
        }

        stage("BUILD DOCKER IMAGE") {
            steps {
                sh 'git checkout main' // Switch to the main branch globally
                dir('Achat') {
                    sh 'docker build -t khaznaji/oumaymalynakhaznaji-5sae4-g1-gestion-station-ski:latest .'
                }
                sh 'docker build -t khaznaji/test:latest -f Dockerfile .'
            }
        }

        stage('docker push') {
            steps {
                script {
                    sh 'docker login -u "khaznaji" -p "191JFT2725" docker.io'
                    sh 'docker push khaznaji/oumaymalynakhaznaji-5sae4-g1-gestion-station-ski:latest'
                    sh 'docker push khaznaji/test:latest'
                }
            }
        }

        stage('docker compose') {
            steps {
                dir('Achat') {
                    sh 'docker compose down --rmi all'
                    sh 'docker compose up -d'
                }
            }
        }

        // stage('MAIL BUILD') {
        //     steps {
        //         script {
        //             currentBuildResult = currentBuild.result
        //             emailext subject: "${currentBuildResult == 'SUCCESS' ? 'Build Successful' : 'Build Failed'}",
        //                     body: "Le build a abouti avec le statut : ${currentBuildResult}",
        //                     recipientProviders: [[$class: 'DevelopersRecipientProvider']],
        //                     to: 'oumaymalyna.khaznaji@esprit.tn',
        //                     from: 'oumaymalyna.khaznaji@esprit.tn',
        //                     replyTo: 'oumaymalyna.khaznaji@esprit.tn'
        //         }
        //     }
        // }
    }
}
